package com.telegrambot.telegrambotjammunity.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

/**
 * –£–õ–£–ß–®–ï–ù–ù–´–ô –°–ï–†–í–ò–° –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –í–ò–î–ï–û
 *
 * –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ:
 * 1. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä—ã (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±) - –ë–´–°–¢–†–û –∏ –ë–ï–°–ü–õ–ê–¢–ù–û
 * 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
 *
 * –°–µ–π—á–∞—Å –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä—ã, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
 * –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 */
@Slf4j
@Service
public class VideoProcessingService {

    private final VideoEmbedService videoEmbedService;

    public VideoProcessingService(VideoEmbedService videoEmbedService) {
        this.videoEmbedService = videoEmbedService;
    }

    /**
     * –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î –û–ë–†–ê–ë–û–¢–ö–ò –í–ò–î–ï–û-–°–°–´–õ–ö–ò
     *
     * –ü—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä—ã.
     * –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ.
     *
     * @param videoLink - —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
     * @return —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
     */
    public String processVideoLink(String videoLink) {
        log.info("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∏–¥–µ–æ-—Å—Å—ã–ª–∫—É: {}", videoLink);

        // –°–¢–†–ê–¢–ï–ì–ò–Ø 1: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è)
        if (videoEmbedService.supportsEmbedding(videoLink)) {
            log.debug("–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–µ–µ—Ä –¥–ª—è: {}", videoLink);
            return videoEmbedService.createEmbeddedVideoMessage(videoLink);
        }

        // –°–¢–†–ê–¢–ï–ì–ò–Ø 2: –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
        // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
        log.warn("–°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: {}", videoLink);
        return "üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ: " + videoLink +
                "\n\n‚ÑπÔ∏è –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ";
    }

    /**
     * –ü–†–û–í–ï–†–Ø–ï–¢, –ù–£–ñ–ù–û –õ–ò –°–ö–ê–ß–ò–í–ê–¢–¨ –í–ò–î–ï–û
     *
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–æ–≥–¥–∞ –Ω–∞–º –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è
     * —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞.
     *
     * –°–µ–π—á–∞—Å –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç false, –Ω–æ –≤ –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É:
     * - –ï—Å–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ
     * - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
     * - –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
     */
    public boolean shouldDownloadVideo(String videoLink) {
        // –°–µ–π—á–∞—Å –æ—Ç–∫–ª—é—á–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä—ã
        return false;

        // –ü—Ä–∏–º–µ—Ä –±—É–¥—É—â–µ–π –ª–æ–≥–∏–∫–∏:
        // return !videoEmbedService.supportsEmbedding(videoLink) ||
        //        videoLink.contains("private-video.com") ||
        //        userRequestedDownload;
    }
}