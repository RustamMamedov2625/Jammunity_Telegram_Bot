package com.telegrambot.telegrambotjammunity.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

/**
 * –°–ï–†–í–ò–° –î–õ–Ø –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø –°–°–´–õ–û–ö –í–û –í–°–¢–†–û–ï–ù–ù–´–ï –í–ò–î–ï–û
 *
 * –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ "–º–∞–≥–∏—é" –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –æ–±—ã—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
 * –≤ –∫—Ä–∞—Å–∏–≤—ã–µ –≤–∏–¥–µ–æ-–ø–ª–µ–µ—Ä—ã –ø—Ä—è–º–æ –≤ Telegram —á–∞—Ç–µ.
 *
 * –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:
 * Telegram –ø–æ–Ω–∏–º–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ—Ç –±–æ—Ç–æ–≤.
 * –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [—Ç–µ–∫—Å—Ç](—Å—Å—ã–ª–∫–∞) —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏
 * –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏, Telegram –ø–æ–∫–∞–∂–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–µ–µ—Ä.
 */
@Slf4j
@Service
public class VideoEmbedService {

    /**
     * –ü–†–ï–û–ë–†–ê–ó–£–ï–¢ –û–ë–´–ß–ù–£–Æ –°–°–´–õ–ö–£ –í –§–û–†–ú–ê–¢ –î–õ–Ø –í–°–¢–†–û–ï–ù–ù–û–ì–û –í–ò–î–ï–û
     *
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±–µ—Ä–µ—Ç –æ–±—ã—á–Ω—É—é —Å—Å—ã–ª–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ YouTube)
     * –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ–µ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç Telegram.
     *
     * @param originalLink - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
     * @return –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
     */
    public String createEmbeddedVideoMessage(String originalLink) {
        log.info("–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Å—ã–ª–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ: {}", originalLink);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–∏–¥–µ–æ –ø–æ –¥–æ–º–µ–Ω—É —Å—Å—ã–ª–∫–∏
        String videoType = detectVideoType(originalLink);
        String title = getVideoTitle(videoType);

        // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
        // –§–æ—Ä–º–∞—Ç: [—Ç–µ–∫—Å—Ç-—Å—Å—ã–ª–∫–∏](—Å–∞–º–∞-—Å—Å—ã–ª–∫–∞)
        String embeddedMessage = String.format("[%s](%s)", title, originalLink);

        log.debug("–°–æ–∑–¥–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ: {}", embeddedMessage);
        return embeddedMessage;
    }

    /**
     * –û–ü–†–ï–î–ï–õ–Ø–ï–¢ –¢–ò–ü –í–ò–î–ï–û –ü–û –°–°–´–õ–ö–ï
     *
     * –°–º–æ—Ç—Ä–∏—Ç –Ω–∞ –¥–æ–º–µ–Ω –≤ —Å—Å—ã–ª–∫–µ –∏ –ø–æ–Ω–∏–º–∞–µ—Ç, —Å –∫–∞–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π —Ä–∞–±–æ—Ç–∞–µ–º.
     * –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç.
     *
     * @param link - —Å—Å—ã–ª–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
     * @return —Ç–∏–ø –≤–∏–¥–µ–æ (youtube, tiktok, instagram)
     */
    private String detectVideoType(String link) {
        if (link.contains("youtube.com") || link.contains("youtu.be")) {
            return "youtube";
        } else if (link.contains("tiktok.com")) {
            return "tiktok";
        } else if (link.contains("instagram.com")) {
            return "instagram";
        } else {
            return "video";
        }
    }

    /**
     * –°–û–ó–î–ê–ï–¢ –ó–ê–ì–û–õ–û–í–û–ö –î–õ–Ø –í–ò–î–ï–û –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ò–ü–ê
     *
     * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Å—ã—Ä–æ–π —Å—Å—ã–ª–∫–∏.
     * Telegram –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω–∏—Ç –µ–≥–æ –Ω–∞ –≤–∏–¥–µ–æ-–ø–ª–µ–µ—Ä.
     *
     * @param videoType - —Ç–∏–ø –≤–∏–¥–µ–æ
     * @return –∫—Ä–∞—Å–∏–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
     */
    private String getVideoTitle(String videoType) {
        switch (videoType) {
            case "youtube":
                return "üé• YouTube –≤–∏–¥–µ–æ";
            case "tiktok":
                return "üì± TikTok –≤–∏–¥–µ–æ";
            case "instagram":
                return "üì∏ Instagram –≤–∏–¥–µ–æ";
            default:
                return "üé¨ –í–∏–¥–µ–æ";
        }
    }

    /**
     * –ü–†–û–í–ï–†–Ø–ï–¢, –ú–û–ñ–ù–û –õ–ò –°–î–ï–õ–ê–¢–¨ –í–°–¢–†–û–ï–ù–ù–û–ï –í–ò–î–ï–û –ò–ó –≠–¢–û–ô –°–°–´–õ–ö–ò
     *
     * –ù–µ –≤—Å–µ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è Telegram –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–º–æ–∂–µ–º –ª–∏ –º—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –ø–ª–µ–µ—Ä.
     *
     * @param link - —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
     * @return true –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
     */
    public boolean supportsEmbedding(String link) {
        // Telegram –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è —ç—Ç–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
        return link.contains("youtube.com") ||
                link.contains("youtu.be") ||
                link.contains("tiktok.com") ||
                link.contains("instagram.com");
    }
}